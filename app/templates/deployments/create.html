{% extends 'base.html' %}
{% block title %}Dagitim Olustur{% endblock %}
{% block content %}
<div class="card" style="max-width: 780px; margin: 0 auto;">
  <div class="row spread wrap">
    <h3 style="margin: 0;">Yeni Dagitim</h3>
    <a class="btn secondary" href="/deployments">Liste</a>
  </div>
  <form id="dep-form" class="grid" style="margin-top: 10px;">
    <div class="grid cols-2">
      <div>
        <label>Uygulama</label>
        <select name="app_id" id="app_id" required></select>
      </div>
      <div>
        <label>Oncelik</label>
        <input name="priority" type="number" value="5" required />
      </div>
    </div>
    <div class="grid cols-2">
      <div>
        <label>Hedef Tipi</label>
        <select name="target_type" id="target_type">
          <option value="All">All</option>
          <option value="Group">Group</option>
          <option value="Agent">Agent</option>
        </select>
      </div>
      <div id="target-group-wrap" style="display:none;">
        <label>Grup</label>
        <select name="target_group_id" id="target_group_id"></select>
      </div>
      <div id="target-agent-wrap" style="display:none;">
        <label>Agent</label>
        <select name="target_agent_uuid" id="target_agent_uuid"></select>
      </div>
    </div>
    <div class="row wrap">
      <label><input type="checkbox" name="is_mandatory" /> Zorunlu</label>
      <label><input type="checkbox" name="force_update" /> Force Update</label>
      <label><input type="checkbox" name="is_active" checked /> Aktif</label>
    </div>
    <button class="btn" type="submit">Olustur</button>
  </form>
</div>
{% endblock %}
{% block scripts %}
<script>
  AppCenterApi.protectPage();

  function syncTargetInputs() {
    const targetType = document.getElementById('target_type').value;
    const groupWrap = document.getElementById('target-group-wrap');
    const agentWrap = document.getElementById('target-agent-wrap');
    groupWrap.style.display = targetType === 'Group' ? '' : 'none';
    agentWrap.style.display = targetType === 'Agent' ? '' : 'none';
  }

  async function loadFormData() {
    const [appsData, agentsData, groupsData] = await Promise.all([
      AppCenterApi.req('/applications?only_active=true'),
      AppCenterApi.req('/agents'),
      AppCenterApi.req('/groups'),
    ]);

    const appSelect = document.getElementById('app_id');
    appSelect.innerHTML = '';
    (appsData.items || []).forEach((app) => {
      const option = document.createElement('option');
      option.value = String(app.id);
      option.textContent = `${app.display_name} (${app.version})`;
      appSelect.appendChild(option);
    });

    const agentSelect = document.getElementById('target_agent_uuid');
    agentSelect.innerHTML = '';
    (agentsData.items || []).forEach((agent) => {
      const option = document.createElement('option');
      option.value = agent.uuid;
      option.textContent = `${agent.hostname} (${agent.uuid})`;
      agentSelect.appendChild(option);
    });

    if (!appSelect.value) {
      throw new Error('Aktif uygulama bulunamadi. Once uygulama ekleyin.');
    }

    const groupSelect = document.getElementById('target_group_id');
    groupSelect.innerHTML = '';
    (groupsData.items || []).forEach((group) => {
      const option = document.createElement('option');
      option.value = String(group.id);
      option.textContent = `${group.name} (#${group.id})`;
      groupSelect.appendChild(option);
    });
  }

  document.getElementById('target_type').addEventListener('change', syncTargetInputs);
  document.getElementById('dep-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = new FormData(e.target);
    const targetType = form.get('target_type');
    let targetId = null;
    if (targetType === 'Group') {
      const raw = (form.get('target_group_id') || '').toString().trim();
      targetId = raw || null;
    } else if (targetType === 'Agent') {
      const raw = (form.get('target_agent_uuid') || '').toString().trim();
      targetId = raw || null;
    }
    const payload = {
      app_id: Number(form.get('app_id')),
      target_type: targetType,
      target_id: targetId,
      is_mandatory: form.get('is_mandatory') === 'on',
      force_update: form.get('force_update') === 'on',
      priority: Number(form.get('priority')),
      is_active: form.get('is_active') === 'on',
    };
    try {
      await AppCenterApi.req('/deployments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      AppCenterApi.toast('Dagitim olusturuldu');
      setTimeout(() => { location.href = '/deployments'; }, 700);
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  });

  (async () => {
    try {
      await loadFormData();
      syncTargetInputs();
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  })();
</script>
{% endblock %}
