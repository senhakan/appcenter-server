{% extends 'base.html' %}
{% block title %}Dagitim Duzenle{% endblock %}
{% block content %}
<div class="card" style="max-width: 900px;">
  <div class="row spread wrap">
    <h3 style="margin: 0;">Dagitim Duzenle</h3>
    <a class="btn secondary" href="/deployments">Liste</a>
  </div>
  <form id="dep-edit-form" class="grid" style="margin-top: 10px;">
    <div class="grid cols-2">
      <div>
        <label>Uygulama</label>
        <select name="app_id" id="app_id" required></select>
      </div>
      <div>
        <label>Oncelik</label>
        <input name="priority" type="number" min="1" value="5" required />
      </div>
    </div>
    <div class="grid cols-2">
      <div>
        <label>Hedef Tipi</label>
        <select name="target_type" id="target_type">
          <option value="All">All</option>
          <option value="Group">Group</option>
          <option value="Agent">Agent</option>
        </select>
      </div>
      <div id="target-group-wrap" style="display:none;">
        <label>Grup</label>
        <select name="target_group_id" id="target_group_id"></select>
      </div>
      <div id="target-agent-wrap" style="display:none;">
        <label>Agent</label>
        <select name="target_agent_uuid" id="target_agent_uuid"></select>
      </div>
    </div>
    <div class="row wrap">
      <label><input type="checkbox" name="is_mandatory" /> Zorunlu</label>
      <label><input type="checkbox" name="force_update" /> Force Update</label>
      <label><input type="checkbox" name="is_active" /> Aktif</label>
    </div>
    <div class="row" style="justify-content: flex-end;">
      <button class="btn" type="submit">Kaydet</button>
    </div>
  </form>
</div>
{% endblock %}
{% block scripts %}
<script>
  AppCenterApi.protectPage();
  const deploymentId = Number("{{ deployment_id }}");
  let loadedDeployment = null;

  function syncTargetInputs() {
    const targetType = document.getElementById('target_type').value;
    document.getElementById('target-group-wrap').style.display = targetType === 'Group' ? '' : 'none';
    document.getElementById('target-agent-wrap').style.display = targetType === 'Agent' ? '' : 'none';
  }

  async function loadFormData() {
    const [dep, appsData, agentsData, groupsData] = await Promise.all([
      AppCenterApi.req(`/deployments/${deploymentId}`),
      AppCenterApi.req('/applications?only_active=true'),
      AppCenterApi.req('/agents'),
      AppCenterApi.req('/groups'),
    ]);
    loadedDeployment = dep;

    const appSelect = document.getElementById('app_id');
    appSelect.innerHTML = '';
    (appsData.items || []).forEach((app) => {
      const option = document.createElement('option');
      option.value = String(app.id);
      option.textContent = `${app.display_name} (${app.version})`;
      appSelect.appendChild(option);
    });

    const agentSelect = document.getElementById('target_agent_uuid');
    agentSelect.innerHTML = '';
    (agentsData.items || []).forEach((agent) => {
      const option = document.createElement('option');
      option.value = agent.uuid;
      option.textContent = `${agent.hostname || agent.uuid} (${agent.uuid})`;
      agentSelect.appendChild(option);
    });

    const groupSelect = document.getElementById('target_group_id');
    groupSelect.innerHTML = '';
    (groupsData.items || []).forEach((group) => {
      const option = document.createElement('option');
      option.value = String(group.id);
      option.textContent = `${group.name} (#${group.id})`;
      groupSelect.appendChild(option);
    });

    const form = document.getElementById('dep-edit-form');
    form.app_id.value = String(dep.app_id);
    form.priority.value = String(dep.priority || 5);
    form.target_type.value = dep.target_type || 'All';
    if (dep.target_type === 'Group' && dep.target_id) form.target_group_id.value = dep.target_id;
    if (dep.target_type === 'Agent' && dep.target_id) form.target_agent_uuid.value = dep.target_id;
    form.is_mandatory.checked = !!dep.is_mandatory;
    form.force_update.checked = !!dep.force_update;
    form.is_active.checked = !!dep.is_active;
    syncTargetInputs();
  }

  document.getElementById('target_type').addEventListener('change', syncTargetInputs);
  document.getElementById('dep-edit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!loadedDeployment) return;
    const form = new FormData(e.target);
    const targetType = (form.get('target_type') || '').toString();
    let targetId = null;
    if (targetType === 'Group') targetId = (form.get('target_group_id') || '').toString() || null;
    if (targetType === 'Agent') targetId = (form.get('target_agent_uuid') || '').toString() || null;
    try {
      await AppCenterApi.req(`/deployments/${deploymentId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          app_id: Number(form.get('app_id')),
          target_type: targetType,
          target_id: targetType === 'All' ? null : targetId,
          priority: Number(form.get('priority')),
          is_mandatory: form.get('is_mandatory') === 'on',
          force_update: form.get('force_update') === 'on',
          is_active: form.get('is_active') === 'on',
        }),
      });
      AppCenterApi.toast('Dagitim guncellendi');
      setTimeout(() => { location.href = '/deployments'; }, 700);
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  });

  loadFormData().catch((err) => AppCenterApi.toast(err.message));
</script>
{% endblock %}
