{% extends 'base.html' %}
{% block title %}Ajan Detay{% endblock %}
{% block content %}
<div class="card">
  <div class="row spread wrap">
    <h3 style="margin: 0;">Ajan Detay</h3>
    <a class="btn secondary" href="/agents">Listeye Don</a>
  </div>
  <div id="agent-detail" class="grid cols-2"></div>
</div>

<div class="card">
  <div class="row" style="gap: 8px; margin-bottom: 16px;">
    <button class="btn" id="tab-inventory" onclick="showTab('inventory')">Yuklu Yazilimlar</button>
    <button class="btn secondary" id="tab-changes" onclick="showTab('changes')">Degisim Gecmisi</button>
    <button class="btn secondary" id="tab-system" onclick="showTab('system')">Sistem Gecmisi</button>
  </div>

  <div id="panel-inventory">
    <div class="row spread wrap" style="margin-bottom: 8px;">
      <input id="inv-search" type="text" placeholder="Yazilim ara..." oninput="filterInventory()" style="max-width:300px;" />
      <span class="muted" id="inv-updated"></span>
    </div>
    <table>
      <thead><tr><th>Yazilim Adi</th><th>Versiyon</th><th>Yayinci</th><th>Boyut (KB)</th><th>Mimari</th></tr></thead>
      <tbody id="inv-body"></tbody>
    </table>
  </div>

  <div id="panel-changes" style="display:none;">
    <table>
      <thead><tr><th>Tarih</th><th>Yazilim</th><th>Islem</th><th>Detay</th></tr></thead>
      <tbody id="changes-body"></tbody>
    </table>
    <div class="row spread" style="margin-top: 8px;">
      <button class="btn secondary" id="changes-more" onclick="loadMoreChanges()">Daha Fazla</button>
    </div>
  </div>

  <div id="panel-system" style="display:none;">
    <table>
      <thead><tr><th>Tarih</th><th>Degisen Bilgiler</th></tr></thead>
      <tbody id="sys-body"></tbody>
    </table>
    <div class="row spread" style="margin-top: 8px;">
      <button class="btn secondary" id="sys-more" onclick="loadMoreSystem()">Daha Fazla</button>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  AppCenterApi.protectPage();
  const agentId = "{{ agent_uuid }}";
  let allInventory = [];
  let changesOffset = 0;
  let systemOffset = 0;

  function showTab(tab) {
    document.getElementById('panel-inventory').style.display = tab === 'inventory' ? '' : 'none';
    document.getElementById('panel-changes').style.display = tab === 'changes' ? '' : 'none';
    document.getElementById('panel-system').style.display = tab === 'system' ? '' : 'none';
    document.getElementById('tab-inventory').className = tab === 'inventory' ? 'btn' : 'btn secondary';
    document.getElementById('tab-changes').className = tab === 'changes' ? 'btn' : 'btn secondary';
    document.getElementById('tab-system').className = tab === 'system' ? 'btn' : 'btn secondary';
  }

  async function loadAgentDetail() {
    try {
      const data = await AppCenterApi.req(`/agents/${agentId}`);
      const el = document.getElementById('agent-detail');
      const sessions = (data.logged_in_sessions || []).map(s => `${s.username} (${s.session_type})`);
      const sessionsText = sessions.length ? sessions.join('<br/>') : '-';
      const sessionsUpdated = data.logged_in_sessions_updated_at ? new Date(data.logged_in_sessions_updated_at).toLocaleString() : '-';
      const sys = data.system_profile || null;
      const sysUpdated = data.system_profile_updated_at ? new Date(data.system_profile_updated_at).toLocaleString() : '-';
      const sysDisks = sys ? ((sys.disks || []).map(d => `Disk ${d.index}: ${d.size_gb || '?'} GB (${d.bus_type || '?'}) ${d.model || ''}`.trim()).join('<br/>') || '-') : '-';
      const sysVirt = sys && sys.virtualization ? `${sys.virtualization.is_virtual ? 'Evet' : 'Hayir'} ${sys.virtualization.vendor || ''} ${sys.virtualization.model || ''}`.trim() : '-';
      el.innerHTML = `
        <div><label>UUID</label><div>${data.uuid}</div></div>
        <div><label>Hostname</label><div>${data.hostname || '-'}</div></div>
        <div><label>IP</label><div>${data.ip_address || '-'}</div></div>
        <div><label>Durum</label><div>${data.status || '-'}</div></div>
        <div><label>Version</label><div>${data.version || '-'}</div></div>
        <div><label>Son Gorulme</label><div>${data.last_seen || '-'}</div></div>
        <div><label>Login Olan Kullanici(lar)</label><div>${sessionsText}</div></div>
        <div><label>Session Guncelleme</label><div>${sessionsUpdated}</div></div>
        <div><label>Sistem Profili Guncelleme</label><div>${sysUpdated}</div></div>
        <div><label>OS</label><div>${sys ? ((sys.os_full_name || '-') + ' ' + (sys.os_version || '') + (sys.build_number ? (' (Build ' + sys.build_number + ')') : '')) : '-'}</div></div>
        <div><label>Mimari</label><div>${sys ? (sys.architecture || '-') : '-'}</div></div>
        <div><label>Marka/Model</label><div>${sys ? ((sys.manufacturer || '-') + ' ' + (sys.model || '')) : '-'}</div></div>
        <div><label>CPU</label><div>${sys ? ((sys.cpu_model || '-') + ' (P:' + (sys.cpu_cores_physical ?? '-') + ' L:' + (sys.cpu_cores_logical ?? '-') + ')') : '-'}</div></div>
        <div><label>RAM</label><div>${sys && sys.total_memory_gb != null ? (sys.total_memory_gb + ' GB') : '-'}</div></div>
        <div><label>Virtual</label><div>${sysVirt || '-'}</div></div>
        <div style="grid-column: span 2;"><label>Diskler</label><div>${sysDisks}</div></div>
      `;
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  }

  async function loadInventory() {
    try {
      const data = await AppCenterApi.req(`/agents/${agentId}/inventory`);
      allInventory = data.items || [];
      document.getElementById('inv-updated').textContent = `${allInventory.length} yazilim`;
      renderInventory(allInventory);
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  }

  function renderInventory(items) {
    const body = document.getElementById('inv-body');
    if (!items.length) { body.innerHTML = '<tr><td colspan="5" class="muted">Envanter verisi yok</td></tr>'; return; }
    body.innerHTML = items.map(i => `<tr>
      <td>${i.software_name}</td>
      <td>${i.software_version || '-'}</td>
      <td>${i.publisher || '-'}</td>
      <td>${i.estimated_size_kb || '-'}</td>
      <td>${i.architecture || '-'}</td>
    </tr>`).join('');
  }

  function filterInventory() {
    const q = document.getElementById('inv-search').value.toLowerCase();
    const filtered = allInventory.filter(i => i.software_name.toLowerCase().includes(q));
    renderInventory(filtered);
  }

  async function loadChanges() {
    try {
      const data = await AppCenterApi.req(`/agents/${agentId}/inventory/changes?limit=50&offset=${changesOffset}`);
      const items = data.items || [];
      const body = document.getElementById('changes-body');
      const badges = { installed: 'color:#22c55e', removed: 'color:#ef4444', updated: 'color:#3b82f6' };
      const labels = { installed: 'Yuklendi', removed: 'Kaldirildi', updated: 'Guncellendi' };
      items.forEach(i => {
        const detail = i.change_type === 'updated' ? `${i.previous_version || '?'} → ${i.software_version || '?'}` : (i.software_version || '-');
        body.innerHTML += `<tr>
          <td>${new Date(i.detected_at).toLocaleString()}</td>
          <td>${i.software_name}</td>
          <td><span style="${badges[i.change_type] || ''};font-weight:600">${labels[i.change_type] || i.change_type}</span></td>
          <td>${detail}</td>
        </tr>`;
      });
      changesOffset += items.length;
      if (items.length < 50) document.getElementById('changes-more').style.display = 'none';
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  }

  function loadMoreChanges() { loadChanges(); }

  async function loadSystemHistory() {
    try {
      const data = await AppCenterApi.req(`/agents/${agentId}/system/history?limit=50&offset=${systemOffset}`);
      const items = data.items || [];
      const body = document.getElementById('sys-body');
      items.forEach(i => {
        const p = i.system_profile || {};
        const fields = (i.changed_fields || []);
        let details = '';

        if (fields.includes('initial')) {
          const summary = `${p.os_full_name || '-'} | ${(p.manufacturer || '-') + ' ' + (p.model || '')} | ${p.cpu_model || '-'} | ${p.total_memory_gb != null ? (p.total_memory_gb + ' GB') : '-'}`;
          details = `<div><b>initial</b>: ${summary}</div>`;
        } else if (!fields.length) {
          details = `<div class="muted">-</div>`;
        } else {
          const diff = (i.diff || []);
          if (!diff.length) {
            // Backward compatibility: fallback to new values only.
            details = fields.map(f => `<div><b>${f}</b>: ${p[f] != null && p[f] !== '' ? p[f] : '-'}</div>`).join('');
          } else {
            details = diff.map(d => {
              const f = d.field || '';
              const oldV = d.old != null && d.old !== '' ? d.old : '-';
              const newV = d.new != null && d.new !== '' ? d.new : '-';
              return `<div><b>${f}</b>: ${oldV} → ${newV}</div>`;
            }).join('');
          }
        }
        body.innerHTML += `<tr>
          <td>${new Date(i.detected_at).toLocaleString()}</td>
          <td>${details}</td>
        </tr>`;
      });
      systemOffset += items.length;
      if (items.length < 50) document.getElementById('sys-more').style.display = 'none';
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  }

  function loadMoreSystem() { loadSystemHistory(); }

  loadAgentDetail();
  loadInventory();
  loadChanges();
  loadSystemHistory();
</script>
{% endblock %}
