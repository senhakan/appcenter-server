{% extends 'base.html' %}
{% block title %}Ajan Detay{% endblock %}
{% block content %}
<style>
  .agent-delete-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(21, 34, 56, 0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 998;
    padding: 16px;
  }
  .agent-delete-modal-backdrop.hidden {
    display: none;
  }
  .agent-delete-modal {
    width: 100%;
    max-width: 520px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 14px;
    box-shadow: var(--shadow);
    padding: 18px;
  }
  .agent-note-col textarea {
    min-height: 82px;
  }
  .agent-disk-col {
    align-self: start;
  }
  .agent-note-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
    justify-content: flex-end;
  }
</style>
<div class="card">
  <div class="row spread wrap">
    <h3 style="margin: 0;">Ajan Detay</h3>
    <div class="row">
      <button class="btn danger" id="agent-delete-btn" type="button">Ajani Sil</button>
      <a class="btn secondary" href="/agents">Listeye Don</a>
    </div>
  </div>
  <div id="agent-detail" class="grid cols-2"></div>
</div>

<div class="card">
  <div class="row" style="gap: 8px; margin-bottom: 16px;">
    <button class="btn" id="tab-inventory" onclick="showTab('inventory')">Yuklu Yazilimlar</button>
    <button class="btn secondary" id="tab-changes" onclick="showTab('changes')">Degisim Gecmisi</button>
    <button class="btn secondary" id="tab-system" onclick="showTab('system')">Sistem Gecmisi</button>
  </div>

  <div id="panel-inventory">
    <div class="row spread" style="margin-bottom: 8px;">
      <input id="inv-search" type="text" placeholder="Yazilim ara..." oninput="filterInventory()" style="max-width:300px;" />
      <span class="muted" id="inv-updated"></span>
    </div>
    <table>
      <thead><tr><th>Yazilim Adi</th><th>Versiyon</th><th>Yayinci</th><th>Boyut (KB)</th><th>Mimari</th></tr></thead>
      <tbody id="inv-body"></tbody>
    </table>
  </div>

  <div id="panel-changes" style="display:none;">
    <table>
      <thead><tr><th>Tarih</th><th>Yazilim</th><th>Islem</th><th>Detay</th></tr></thead>
      <tbody id="changes-body"></tbody>
    </table>
    <div class="row spread" style="margin-top: 8px;">
      <button class="btn secondary" id="changes-more" onclick="loadMoreChanges()">Daha Fazla</button>
    </div>
  </div>

  <div id="panel-system" style="display:none;">
    <table>
      <thead><tr><th>Tarih</th><th>Degisen Bilgiler</th></tr></thead>
      <tbody id="sys-body"></tbody>
    </table>
    <div class="row spread" style="margin-top: 8px;">
      <button class="btn secondary" id="sys-more" onclick="loadMoreSystem()">Daha Fazla</button>
    </div>
  </div>
</div>

<div id="agent-delete-modal" class="agent-delete-modal-backdrop hidden" aria-live="polite">
  <div class="agent-delete-modal">
    <div class="row spread wrap" style="margin-bottom: 10px;">
      <h3 style="margin: 0;">Ajan Silme Onayi</h3>
    </div>
    <div id="agent-delete-message" class="muted" style="margin-bottom: 14px;"></div>
    <div class="row" style="justify-content:flex-end;">
      <button class="btn secondary" id="agent-delete-cancel-btn" type="button">Iptal</button>
      <button class="btn danger" id="agent-delete-confirm-btn" type="button">Sil</button>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  AppCenterApi.protectPage();
  const agentId = "{{ agent_uuid }}";
  let agentHostname = "";
  let allInventory = [];
  let changesOffset = 0;
  let systemOffset = 0;
  let savedNote = '';
  const deleteModal = document.getElementById('agent-delete-modal');

  function getNoteElements() {
    return {
      noteInput: document.getElementById('agent-note-input'),
      noteSaveBtn: document.getElementById('agent-note-save-btn'),
    };
  }

  function openDeleteModal() { deleteModal.classList.remove('hidden'); }
  function closeDeleteModal() { deleteModal.classList.add('hidden'); }

  function showTab(tab) {
    document.getElementById('panel-inventory').style.display = tab === 'inventory' ? '' : 'none';
    document.getElementById('panel-changes').style.display = tab === 'changes' ? '' : 'none';
    document.getElementById('panel-system').style.display = tab === 'system' ? '' : 'none';
    document.getElementById('tab-inventory').className = tab === 'inventory' ? 'btn' : 'btn secondary';
    document.getElementById('tab-changes').className = tab === 'changes' ? 'btn' : 'btn secondary';
    document.getElementById('tab-system').className = tab === 'system' ? 'btn' : 'btn secondary';
  }

  function syncNoteSaveButton() {
    const { noteInput, noteSaveBtn } = getNoteElements();
    if (!noteInput || !noteSaveBtn) return;
    const current = (noteInput.value || '').trim();
    const dirty = current !== savedNote;
    noteSaveBtn.disabled = !dirty;
    noteSaveBtn.className = dirty ? 'btn' : 'btn secondary';
  }

  async function saveNote() {
    const { noteInput, noteSaveBtn } = getNoteElements();
    if (!noteInput || !noteSaveBtn || noteSaveBtn.disabled) return;
    try {
      const payload = { notes: noteInput.value || '' };
      const updated = await AppCenterApi.req(`/agents/${agentId}/notes`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      savedNote = (updated.notes || '').trim();
      noteInput.value = updated.notes || '';
      syncNoteSaveButton();
      AppCenterApi.toast('Not kaydedildi');
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  }

  async function loadAgentDetail() {
    try {
      await AppCenterApi.initUi();
      const data = await AppCenterApi.req(`/agents/${agentId}`);
      agentHostname = data.hostname || '';
      const el = document.getElementById('agent-detail');
      const sessions = (data.logged_in_sessions || []).map(s => `${s.username} (${s.session_type})`);
      const sessionsText = sessions.length ? sessions.join('<br/>') : '-';
      const sessionsUpdated = data.logged_in_sessions_updated_at ? AppCenterApi.formatDate(data.logged_in_sessions_updated_at) : '-';
      const sys = data.system_profile || null;
      const sysUpdated = data.system_profile_updated_at ? AppCenterApi.formatDate(data.system_profile_updated_at) : '-';
      const sysDisks = sys ? ((sys.disks || []).map(d => `Disk ${d.index}: ${d.size_gb || '?'} GB (${d.bus_type || '?'}) ${d.model || ''}`.trim()).join('<br/>') || '-') : '-';
      const sysVirt = sys && sys.virtualization ? `${sys.virtualization.is_virtual ? 'Evet' : 'Hayir'} ${sys.virtualization.vendor || ''} ${sys.virtualization.model || ''}`.trim() : '-';
      el.innerHTML = `
        <div><label>UUID</label><div>${data.uuid}</div></div>
        <div><label>Hostname</label><div>${data.hostname || '-'}</div></div>
        <div><label>IP</label><div>${data.ip_address || '-'}</div></div>
        <div><label>Durum</label><div>${data.status || '-'}</div></div>
        <div><label>Version</label><div>${data.version || '-'}</div></div>
        <div><label>Son Gorulme</label><div>${data.last_seen ? AppCenterApi.formatDate(data.last_seen) : '-'}</div></div>
        <div><label>Login Olan Kullanici(lar)</label><div>${sessionsText}</div></div>
        <div><label>Session Guncelleme</label><div>${sessionsUpdated}</div></div>
        <div><label>Sistem Profili Guncelleme</label><div>${sysUpdated}</div></div>
        <div><label>OS</label><div>${sys ? ((sys.os_full_name || '-') + ' ' + (sys.os_version || '') + (sys.build_number ? (' (Build ' + sys.build_number + ')') : '')) : '-'}</div></div>
        <div><label>Mimari</label><div>${sys ? (sys.architecture || '-') : '-'}</div></div>
        <div><label>Marka/Model</label><div>${sys ? ((sys.manufacturer || '-') + ' ' + (sys.model || '')) : '-'}</div></div>
        <div><label>CPU</label><div>${sys ? ((sys.cpu_model || '-') + ' (P:' + (sys.cpu_cores_physical ?? '-') + ' L:' + (sys.cpu_cores_logical ?? '-') + ')') : '-'}</div></div>
        <div><label>RAM</label><div>${sys && sys.total_memory_gb != null ? (sys.total_memory_gb + ' GB') : '-'}</div></div>
        <div><label>Virtual</label><div>${sysVirt || '-'}</div></div>
        <div></div>
        <div class="agent-disk-col"><label>Diskler</label><div>${sysDisks}</div></div>
        <div class="agent-note-col" style="grid-column: span 2;">
          <label for="agent-note-input">Not</label>
          <textarea id="agent-note-input" rows="3" maxlength="2000" placeholder="Ajan ile ilgili not..."></textarea>
          <div class="agent-note-actions">
            <button class="btn secondary" id="agent-note-save-btn" type="button" disabled>Kaydet</button>
          </div>
        </div>
      `;
      savedNote = (data.notes || '').trim();
      const { noteInput, noteSaveBtn } = getNoteElements();
      if (noteInput) noteInput.value = data.notes || '';
      if (noteInput) noteInput.addEventListener('input', syncNoteSaveButton);
      if (noteSaveBtn) noteSaveBtn.addEventListener('click', saveNote);
      syncNoteSaveButton();
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  }

  async function loadInventory() {
    try {
      const data = await AppCenterApi.req(`/agents/${agentId}/inventory`);
      allInventory = data.items || [];
      filterInventory();
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  }

  function renderInventory(items) {
    const body = document.getElementById('inv-body');
    if (!items.length) { body.innerHTML = '<tr><td colspan="5" class="muted">Envanter verisi yok</td></tr>'; return; }
    body.innerHTML = items.map(i => `<tr>
      <td>${i.software_name}</td>
      <td>${i.software_version || '-'}</td>
      <td>${i.publisher || '-'}</td>
      <td>${i.estimated_size_kb || '-'}</td>
      <td>${i.architecture || '-'}</td>
    </tr>`).join('');
  }

  function filterInventory() {
    const q = (document.getElementById('inv-search').value || '').toLowerCase();
    const filtered = allInventory.filter((i) => {
      const name = (i.software_name || '').toLowerCase();
      if (!name.includes(q)) return false;
      return true;
    });
    document.getElementById('inv-updated').textContent = `${filtered.length}/${allInventory.length} yazilim`;
    renderInventory(filtered);
  }

  async function loadChanges() {
    try {
      await AppCenterApi.initUi();
      const data = await AppCenterApi.req(`/agents/${agentId}/inventory/changes?limit=50&offset=${changesOffset}`);
      const items = data.items || [];
      const body = document.getElementById('changes-body');
      const badges = { installed: 'color:#22c55e', removed: 'color:#ef4444', updated: 'color:#3b82f6' };
      const labels = { installed: 'Yuklendi', removed: 'Kaldirildi', updated: 'Guncellendi' };
      items.forEach(i => {
        const detail = i.change_type === 'updated' ? `${i.previous_version || '?'} → ${i.software_version || '?'}` : (i.software_version || '-');
        body.innerHTML += `<tr>
          <td>${AppCenterApi.formatDate(i.detected_at)}</td>
          <td>${i.software_name}</td>
          <td><span style="${badges[i.change_type] || ''};font-weight:600">${labels[i.change_type] || i.change_type}</span></td>
          <td>${detail}</td>
        </tr>`;
      });
      changesOffset += items.length;
      if (items.length < 50) document.getElementById('changes-more').style.display = 'none';
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  }

  function loadMoreChanges() { loadChanges(); }

  async function loadSystemHistory() {
    try {
      await AppCenterApi.initUi();
      const data = await AppCenterApi.req(`/agents/${agentId}/timeline?limit=50&offset=${systemOffset}`);
      const items = data.items || [];
      const body = document.getElementById('sys-body');
      items.forEach(i => {
        let details = '';
        if (i.event_type === 'identity') {
          const hOld = i.old_hostname || '-';
          const hNew = i.new_hostname || '-';
          const ipOld = i.old_ip_address || '-';
          const ipNew = i.new_ip_address || '-';
          details = `
            <div><b>hostname</b>: ${hOld} → ${hNew}</div>
            <div><b>ip</b>: ${ipOld} → ${ipNew}</div>
          `;
        } else if (i.event_type === 'status') {
          const sOld = i.old_status || '-';
          const sNew = i.new_status || '-';
          const reason = i.reason ? ` (${i.reason})` : '';
          details = `<div><b>status</b>: ${sOld} → ${sNew}${reason}</div>`;
        } else if (i.event_type === 'task') {
          const act = i.task_action || '-';
          const st = i.task_status || '-';
          const app = i.app_name || '-';
          const exit = (i.exit_code != null) ? ` (exit=${i.exit_code})` : '';
          const msg = i.message ? ` | ${i.message}` : '';
          details = `<div><b>task</b>: ${act} ${app} → ${st}${exit}${msg}</div>`;
        } else {
          const p = i.system_profile || {};
          const fields = (i.changed_fields || []);
          if (fields.includes('initial')) {
            const summary = `${p.os_full_name || '-'} | ${(p.manufacturer || '-') + ' ' + (p.model || '')} | ${p.cpu_model || '-'} | ${p.total_memory_gb != null ? (p.total_memory_gb + ' GB') : '-'}`;
            details = `<div><b>initial</b>: ${summary}</div>`;
          } else if (!fields.length) {
            details = `<div class="muted">-</div>`;
          } else {
            const diff = (i.diff || []);
            if (!diff.length) {
              details = fields.map(f => `<div><b>${f}</b>: ${p[f] != null && p[f] !== '' ? p[f] : '-'}</div>`).join('');
            } else {
              details = diff.map(d => {
                const f = d.field || '';
                const oldV = d.old != null && d.old !== '' ? d.old : '-';
                const newV = d.new != null && d.new !== '' ? d.new : '-';
                return `<div><b>${f}</b>: ${oldV} → ${newV}</div>`;
              }).join('');
            }
          }
        }
        body.innerHTML += `<tr>
          <td>${AppCenterApi.formatDate(i.detected_at)}</td>
          <td>${details}</td>
        </tr>`;
      });
      systemOffset += items.length;
      if (items.length < 50) document.getElementById('sys-more').style.display = 'none';
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  }

  function loadMoreSystem() { loadSystemHistory(); }

  document.getElementById('agent-delete-btn').addEventListener('click', () => {
    const shown = agentHostname || agentId;
    document.getElementById('agent-delete-message').textContent =
      `'${shown}' ajanini silmek istiyor musunuz? Bu islem geri alinamaz.`;
    openDeleteModal();
  });
  document.getElementById('agent-delete-cancel-btn').addEventListener('click', closeDeleteModal);
  deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) closeDeleteModal(); });
  document.getElementById('agent-delete-confirm-btn').addEventListener('click', async () => {
    try {
      await AppCenterApi.req(`/agents/${agentId}`, { method: 'DELETE' });
      AppCenterApi.toast('Ajan silindi');
      setTimeout(() => { location.href = '/agents'; }, 400);
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  });
  (async function () {
    await AppCenterApi.initUi();
    loadAgentDetail();
    loadInventory();
    loadChanges();
    loadSystemHistory();
  })();
</script>
{% endblock %}
