{% extends 'base.html' %}
{% block title %}Gruplar{% endblock %}
{% block content %}
<style>
  .groups-grid {
    align-items: start;
  }
  .groups-grid .card {
    height: 100%;
  }
  .groups-actions {
    display: flex;
    justify-content: flex-end;
  }
  .groups-hint {
    font-size: 0.85rem;
    color: var(--muted);
  }
  .transfer {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 12px;
    align-items: center;
  }
  .transfer-actions {
    display: grid;
    gap: 8px;
  }
  .transfer select {
    min-height: 260px;
  }
</style>

<div class="grid cols-2 groups-grid">
  <div class="card">
    <h3 style="margin-top: 0;">Grup Olustur</h3>
    <form id="group-create-form" class="grid">
      <div>
        <label>Grup Adi</label>
        <input name="name" required />
      </div>
      <div>
        <label>Aciklama</label>
        <input name="description" />
      </div>
      <div class="groups-actions">
        <button class="btn" type="submit">Olustur</button>
      </div>
    </form>
  </div>
  <div class="card">
    <h3 style="margin-top: 0;">Gruba Ajan Ata</h3>
    <form id="group-assign-form" class="grid">
      <div>
        <label>Grup</label>
        <select id="assign-group-id" required></select>
      </div>
      <div class="transfer">
        <div>
          <label>Atanmamis Ajanlar</label>
          <select id="available-agent-uuids" multiple></select>
        </div>
        <div class="transfer-actions">
          <button class="btn secondary" type="button" id="move-right-all">>></button>
          <button class="btn secondary" type="button" id="move-right">></button>
          <button class="btn secondary" type="button" id="move-left"><</button>
          <button class="btn secondary" type="button" id="move-left-all"><<</button>
        </div>
        <div>
          <label>Gruptaki Ajanlar</label>
          <select id="assigned-agent-uuids" multiple></select>
        </div>
      </div>
      <div class="groups-hint" id="assign-summary"></div>
      <div class="groups-actions">
        <button class="btn" type="submit">Atamalari Kaydet</button>
      </div>
    </form>
  </div>
</div>

<div class="card" style="margin-top: 16px;">
  <div class="row spread wrap">
    <h3 style="margin: 0;">Grup Listesi</h3>
    <button class="btn secondary" onclick="loadData()">Yenile</button>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Grup Adi</th><th>Aciklama</th><th>Ajan Sayisi</th><th></th>
        </tr>
      </thead>
      <tbody id="group-rows"></tbody>
    </table>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  AppCenterApi.protectPage();

  let groups = [];
  let agents = [];

  function toOption(agent, selected = false) {
    const o = document.createElement('option');
    o.value = agent.uuid;
    o.textContent = `${agent.hostname || agent.uuid} (${agent.uuid})`;
    o.selected = selected;
    return o;
  }

  function selectValues(selectEl) {
    return Array.from(selectEl.options || []).map((o) => o.value);
  }

  function moveSelected(fromEl, toEl) {
    const selected = Array.from(fromEl.selectedOptions || []);
    selected.forEach((opt) => {
      toEl.appendChild(opt);
      opt.selected = false;
    });
  }

  function moveAll(fromEl, toEl) {
    const all = Array.from(fromEl.options || []);
    all.forEach((opt) => {
      toEl.appendChild(opt);
      opt.selected = false;
    });
  }

  function renderGroupsTable() {
    const rows = document.getElementById('group-rows');
    rows.innerHTML = '';
    groups.forEach((g) => {
      const count = agents.filter((a) => a.group_id === g.id).length;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${g.id}</td>
        <td>${g.name}</td>
        <td>${g.description || '-'}</td>
        <td>${count}</td>
        <td><a class="btn secondary" href="/groups/${g.id}/edit">Duzenle</a></td>
      `;
      rows.appendChild(tr);
    });
  }

  function renderSelectors() {
    const groupSelect = document.getElementById('assign-group-id');
    groupSelect.innerHTML = '';
    groups.forEach((g) => {
      const op = document.createElement('option');
      op.value = String(g.id);
      op.textContent = `${g.name} (#${g.id})`;
      groupSelect.appendChild(op);
    });

    syncSelectedAgentsForCurrentGroup();
  }

  function syncSelectedAgentsForCurrentGroup() {
    const groupId = Number(document.getElementById('assign-group-id').value || 0);
    const availableEl = document.getElementById('available-agent-uuids');
    const assignedEl = document.getElementById('assigned-agent-uuids');
    const inGroup = agents.filter((a) => Number(a.group_id || 0) === groupId);
    const outGroup = agents.filter((a) => Number(a.group_id || 0) !== groupId);
    availableEl.innerHTML = '';
    assignedEl.innerHTML = '';
    outGroup.forEach((a) => availableEl.appendChild(toOption(a)));
    inGroup.forEach((a) => assignedEl.appendChild(toOption(a)));
    document.getElementById('assign-summary').textContent =
      `Secili grup icin mevcut atama: ${inGroup.length} ajan | Atanmamis: ${outGroup.length}`;
  }

  async function loadData() {
    const [g, a] = await Promise.all([
      AppCenterApi.req('/groups'),
      AppCenterApi.req('/agents'),
    ]);
    groups = g.items || [];
    agents = a.items || [];
    renderSelectors();
    renderGroupsTable();
  }

  document.getElementById('group-create-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const f = new FormData(e.target);
    const payload = {
      name: (f.get('name') || '').toString(),
      description: (f.get('description') || '').toString(),
    };
    try {
      await AppCenterApi.req('/groups', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      e.target.reset();
      await loadData();
      AppCenterApi.toast('Grup olusturuldu');
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  });

  document.getElementById('assign-group-id').addEventListener('change', syncSelectedAgentsForCurrentGroup);
  document.getElementById('move-right').addEventListener('click', () => {
    moveSelected(document.getElementById('available-agent-uuids'), document.getElementById('assigned-agent-uuids'));
  });
  document.getElementById('move-left').addEventListener('click', () => {
    moveSelected(document.getElementById('assigned-agent-uuids'), document.getElementById('available-agent-uuids'));
  });
  document.getElementById('move-right-all').addEventListener('click', () => {
    moveAll(document.getElementById('available-agent-uuids'), document.getElementById('assigned-agent-uuids'));
  });
  document.getElementById('move-left-all').addEventListener('click', () => {
    moveAll(document.getElementById('assigned-agent-uuids'), document.getElementById('available-agent-uuids'));
  });

  document.getElementById('group-assign-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const groupId = Number(document.getElementById('assign-group-id').value || 0);
    if (!groupId) {
      AppCenterApi.toast('Grup seciniz');
      return;
    }
    const uuids = selectValues(document.getElementById('assigned-agent-uuids'));
    try {
      await AppCenterApi.req(`/groups/${groupId}/agents`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agent_uuids: uuids }),
      });
      await loadData();
      AppCenterApi.toast('Atamalar guncellendi');
    } catch (err) {
      AppCenterApi.toast(err.message);
    }
  });

  loadData().catch((err) => AppCenterApi.toast(err.message));
</script>
{% endblock %}
